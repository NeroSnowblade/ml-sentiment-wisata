{% extends 'base.html' %}
{% block title %}Input Ulasan - Sentimen Ulasan Wisata{% endblock %}
{% block content %}
<div class="container-fluid">
  <div class="row justify-content-center">
    <div class="col-12 col-lg-8">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title mb-3">Analisis Sentimen Ulasan</h5>
          <form method="POST" id="ulasan-form">
            <div class="mb-3">
              <label for="ulasan" class="form-label">Tulis Ulasan Wisata</label>
              <textarea class="form-control" id="ulasan" name="ulasan" rows="5" placeholder="Contoh: Tempatnya bagus banget, pemandangannya keren..." required>{{ ulasan or '' }}</textarea>
            </div>
            <div class="mb-3">
              <label for="location" class="form-label">Lokasi</label>
              <div class="input-group">
                <!-- Single select which submits as 'location' field. Options are loaded via AJAX from /api/locations. -->
                <select id="location-select" name="location" class="form-select me-2" aria-label="Pilih lokasi">
                  <option value="">-- Pilih lokasi --</option>
                  {% if location %}
                  <option selected value="{{ location }}">{{ location }}</option>
                  {% endif %}
                </select>
              </div>
              <div class="form-text">Pilih lokasi yang ada atau ketik nama baru (baru akan dibuat saat disubmit).</div>
            </div>
            <button type="submit" class="btn btn-dark text-white">Analisis</button>
          </form>
          {% if result %}
          <hr>
          <div class="alert alert-info mt-3">
            Hasil sentimen: <strong class="text-uppercase">{{ result }}</strong>
            {% if proba is not none %}
              <div class="small text-muted">Kepercayaan model: {{ (proba*100)|round(1) }}%</div>
            {% endif %}
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  <div class="row justify-content-center">
    <div class="col-12">
      <!-- Reviews table -->
      <div class="card shadow-sm mt-3">
        <div class="card-body">
          <h5 class="card-title mb-3">Daftar Ulasan</h5>
          <div class="row mb-2">
            <div class="col-6 col-md-4 mb-2">
              <div class="input-group">
                <!-- Filter select (Select2 AJAX). Empty option allows 'all' -->
                <select id="filter-location-select" class="form-select me-2">
                  <option value="">Semua lokasi</option>
                </select>
              </div>
            </div>
            <div class="col-6 col-md-4 mb-2">
              <select id="per-page" class="form-select">
                <option value="5">5 / halaman</option>
                <option value="10" selected>10 / halaman</option>
                <option value="25">25 / halaman</option>
              </select>
            </div>
          </div>
          <div class="table-responsive">
            <table class="table table-sm table-striped" id="reviews-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Tanggal</th>
                  <th>Lokasi</th>
                  <th>Sentimen</th>
                  <th>Ulasan</th>
                  <th>Akurasi</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <nav>
            <ul class="pagination" id="reviews-pagination"></ul>
          </nav>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Location select uses Select2 + AJAX for autocomplete (no datalist needed)

// Initialize Select2 for location select (searchable + creatable via tags), using AJAX to read from /api/locations
const locationSelect = document.getElementById('location-select');
try {
  $(locationSelect).select2({
    placeholder: '-- Pilih lokasi --',
    allowClear: true,
    tags: true,
    width: 'resolve',
    ajax: {
      url: '/api/locations',
      dataType: 'json',
      delay: 250,
      data: function (params) { return { q: params.term || '' }; },
      processResults: function (data) {
        return { results: data.map(function(x){ return { id: x, text: x }; }) };
      },
      cache: true
    },
    createTag: function (params) {
      return { id: params.term, text: params.term, newTag: true };
    }
  });
  // if server provided an initial location value, ensure it's selected
  {% if location %}
  (function(){
    const initVal = "{{ location }}";
    if (initVal && !Array.from(locationSelect.options).some(o => o.value === initVal)) {
      const opt = new Option(initVal, initVal, true, true);
      locationSelect.add(opt);
    }
    $(locationSelect).val(initVal).trigger('change');
  })();
  {% endif %}
} catch (err) {
  // Select2 not available, select remains a plain select
}

// Initialize Select2 for filter select (searchable via AJAX)
const filterSelect = document.getElementById('filter-location-select');
try {
  $(filterSelect).select2({
    placeholder: 'Semua lokasi',
    allowClear: true,
    width: 'resolve',
    ajax: {
      url: '/api/locations',
      dataType: 'json',
      delay: 250,
      data: function (params) { return { q: params.term || '' }; },
      processResults: function (data) {
        return { results: data.map(function(x){ return { id: x, text: x }; }) };
      },
      cache: true
    }
  });
  $(filterSelect).on('change', function () { loadReviews(1); });
} catch (err) {
  // fallback: basic select onchange is handled below
}

// Reviews table with pagination and filtering
const reviewsTableBody = document.querySelector('#reviews-table tbody');
const paginationEl = document.getElementById('reviews-pagination');
const perPageSelect = document.getElementById('per-page');
let currentPage = 1;

async function loadReviews(page=1) {
  const per_page = perPageSelect.value || 10;
  const location = (filterSelect && filterSelect.value) ? filterSelect.value : '';
  const url = `/api/reviews?page=${page}&per_page=${per_page}&location=${encodeURIComponent(location)}`;
  const res = await fetch(url);
  if (!res.ok) return;
  const data = await res.json();
  reviewsTableBody.innerHTML = '';
  data.items.forEach(r => {
    const tr = document.createElement('tr');
    // format date-only (no time). If created_at is ISO-like, parse it; otherwise show as-is
    function fmtDateOnly(dt) {
      if (!dt) return '';
      try {
        const d = new Date(dt);
        if (!isNaN(d)) return d.toLocaleDateString('id-ID');
      } catch (e) {}
      // fallback: take first 10 chars
      return dt.toString().slice(0,10);
    }
    const dateOnly = fmtDateOnly(r.created_at);
    // accuracy: try r.accuracy, then r.proba (as fraction), then blank
    let accText = '';
    if (r.accuracy !== undefined && r.accuracy !== null) {
      const av = Number(r.accuracy);
      if (!isNaN(av)) accText = (av > 1 ? av : (av * 100)).toFixed(1) + '%';
    } else if (r.proba !== undefined && r.proba !== null) {
      const pv = Number(r.proba);
      if (!isNaN(pv)) accText = (pv > 1 ? pv : (pv * 100)).toFixed(1) + '%';
    }
    tr.innerHTML = `<td>${r.id}</td><td>${dateOnly}</td><td>${r.location||''}</td><td>${r.sentiment}</td><td>${(r.text||'').slice(0,120)}</td><td>${accText}</td>`;
    reviewsTableBody.appendChild(tr);
  });
  renderPagination(data.page, data.pages);
}

function renderPagination(page, pages) {
  currentPage = page;
  paginationEl.innerHTML = '';
  // short pagination: show first, prev, 2 before/after, next, last
  const makeLi = (label, p, disabled=false, active=false) => {
    const li = document.createElement('li');
    li.className = 'page-item' + (disabled ? ' disabled' : '') + (active ? ' active' : '');
    const a = document.createElement('a');
    a.className = 'page-link';
    a.href = '#';
    a.textContent = label;
    a.addEventListener('click', (e) => { e.preventDefault(); if (!disabled) loadReviews(p); });
    li.appendChild(a);
    return li;
  };
  paginationEl.appendChild(makeLi('«', 1, page===1));
  paginationEl.appendChild(makeLi('‹', Math.max(1, page-1), page===1));
  for (let p = Math.max(1, page-2); p <= Math.min(pages, page+2); p++) {
    paginationEl.appendChild(makeLi(p, p, false, p===page));
  }
  paginationEl.appendChild(makeLi('›', Math.min(pages, page+1), page===pages));
  paginationEl.appendChild(makeLi('»', pages, page===pages));
}

perPageSelect.addEventListener('change', () => loadReviews(1));
if (filterSelect) filterSelect.addEventListener('change', () => loadReviews(1));
// initial load
loadReviews(1);
</script>
{% endblock %}